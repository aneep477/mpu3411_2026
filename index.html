// =================================================================
// PENTING: ID Google Spreadsheet Anda yang Sebenar
// =================================================================
const SPREADSHEET_ID = '1_Sw7I8uYiFBJGpjWbMTo53DisiIgGMfui5jMa5AzL7g'; 
// =================================================================


// --- 1. Fungsi untuk Mengambil Data (doGet) ---
// Digunakan oleh HTML untuk memuatkan senarai Kelas dan Pelajar (Langkah 5)

function doGet(e) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheetName = 'DATA_PELAJAR';
  const sheet = ss.getSheetByName(sheetName);
  
  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify({ result: "error", message: "Helaian DATA_PELAJAR tidak ditemui." }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // Ambil semua data dari helaian DATA_PELAJAR (tidak termasuk baris header)
  const range = sheet.getDataRange();
  const values = range.getValues();
  
  if (values.length < 2) {
    // Hanya ada header, tiada data pelajar
    return ContentService.createTextOutput(JSON.stringify({ result: "success", data: [] }))
      .setMimeType(ContentService.MimeType.JSON)
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  }

  const headers = values[0];
  const studentData = values.slice(1);

  // Cari indeks lajur yang diperlukan
  const idIndex = headers.indexOf('ID_SISTEM');
  const nameIndex = headers.indexOf('Nama_Pelajar');
  const classIndex = headers.indexOf('Kelas');
  
  if (idIndex === -1 || nameIndex === -1 || classIndex === -1) {
    return ContentService.createTextOutput(JSON.stringify({ result: "error", message: "Lajur yang diperlukan (ID_SISTEM, Nama_Pelajar, Kelas) tidak ditemui dalam DATA_PELAJAR." }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const processedData = studentData.map(row => {
    return {
      ID_SISTEM: row[idIndex],
      Nama_Pelajar: row[nameIndex],
      Kelas: row[classIndex]
    };
  });

  // Pulangkan data dalam format JSON
  return ContentService.createTextOutput(JSON.stringify({
    result: "success",
    data: processedData
  }))
  .setMimeType(ContentService.MimeType.JSON)
  .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL); 
}


// --- 2. Fungsi Khas untuk Muat Naik Pukal ---
// Dipanggil oleh doPost jika ia adalah permintaan muat naik fail (Langkah 6)

function handleBulkUpload(fileBlob) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('DATA_PELAJAR');
  
  if (!sheet) {
    return { result: "error", message: "Helaian DATA_PELAJAR tidak ditemui." };
  }

  // Baca fail sebagai teks
  const csvData = fileBlob.getDataAsString();
  
  // Parse CSV (menganggap koma sebagai delimiter)
  const data = Utilities.parseCsv(csvData);
  
  if (data.length <= 1) {
    return { result: "error", message: "Fail kosong atau hanya mengandungi header." };
  }

  // Header yang dijangkakan
  const expectedHeaders = ['ID_SISTEM', 'Nama_Pelajar', 'Jantina', 'No_KP', 'No_Giliran', 'Kelas', 'Penilai'];
  const uploadedHeaders = data[0];

  // Periksa kesahihan header
  if (uploadedHeaders.length !== expectedHeaders.length || uploadedHeaders.join(',') !== expectedHeaders.join(',')) {
    return { result: "error", message: "Header fail tidak sepadan. Sila semak turutan lajur: ID_SISTEM, Nama_Pelajar, Jantina, No_KP, No_Giliran, Kelas, Penilai." };
  }

  // Padamkan data lama dan tulis data baharu
  sheet.clearContents();
  
  // Tulis semua data termasuk header
  const rowsToWrite = data;
  sheet.getRange(1, 1, rowsToWrite.length, rowsToWrite[0].length).setValues(rowsToWrite);
  
  return { result: "success", count: rowsToWrite.length - 1, message: "Data pelajar berjaya dimuat naik dan dikemas kini!" };
}


// --- 3. Fungsi Utama POST (doPost) ---
// Mengendalikan kedua-dua penghantaran markah borang dan muat naik pukal

function doPost(e) {
  
  // A. Logik Muat Naik Pukal 
  if (e.parameter.isBulkUpload === 'true' && e.parameters.file) {
    const fileBlob = e.parameters.file;
    return ContentService.createTextOutput(JSON.stringify(handleBulkUpload(fileBlob)))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // B. Logik Penghantaran Markah Borang (Sedia Ada)
  
  const data = e.parameter;
  const sheetName = data.sheet; 
  
  if (!sheetName) {
    return ContentService.createTextOutput(JSON.stringify({result: "error", message: "Nama helaian (sheet) tidak dinyatakan."}))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(sheetName);

  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify({result: "error", message: "Helaian '" + sheetName + "' tidak wujud."}))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const timestamp = new Date();
  const rowData = [];
  
  // Ambil header helaian
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn() || 10).getValues()[0]; 
  
  headers.forEach(header => {
    // Cuba padankan dengan nama header yang dihantar
    if (data[header]) {
      rowData.push(data[header]);
    } else if (header.includes('Tarikh_Input')) {
      rowData.push(timestamp);
    } else {
      rowData.push(''); // Biarkan kosong
    }
  });

  sheet.appendRow(rowData);

  return ContentService.createTextOutput(JSON.stringify({result: "success", message: "Data berjaya direkodkan di helaian " + sheetName}))
    .setMimeType(ContentService.MimeType.JSON);
}

function setup() {
  // Fungsi setup adalah pilihan, hanya untuk memastikan skrip dikenali oleh Apps Script
}
