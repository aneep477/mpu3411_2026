<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pemarkahan MPU3411</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Gaya asas untuk memastikan navigasi atas adalah tetap */
        .fixed-header {
            z-index: 20;
            top: 0;
            left: 0;
            right: 0;
            height: 120px; 
        }
        .main-content-area {
            padding-top: 140px; 
            padding-left: 2rem;
            padding-right: 2rem;
            min-height: 100vh;
        }
        .content-section { display: none; }
        #dashboard-view { display: block; } 
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    
    <header class="fixed-header bg-gray-900 text-white shadow-xl">
        <div class="p-4 flex items-center justify-between border-b border-gray-700">
            <div class="text-3xl font-extrabold text-yellow-400">
                MPU3411 SCORING SYSTEM
            </div>
            <div class="text-sm text-gray-400">
                Direka untuk MPU3411 | Selamat Datang, Penilai
            </div>
        </div>
        
        <nav class="flex justify-start space-x-2 px-4 py-2 bg-gray-800">
            
            <a href="#" class="nav-item flex items-center p-3 rounded-xl text-sm font-bold hover:bg-gray-700 transition duration-150 bg-gray-700" data-target="dashboard-view">
                <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
            </a>
            <a href="#" class="nav-item flex items-center p-3 rounded-xl text-sm font-bold hover:bg-gray-700 transition duration-150" data-target="data-pelajar-view">
                <i class="fas fa-upload mr-2"></i> Muat Naik Pelajar
            </a>

            <a href="#" class="nav-item flex items-center p-3 rounded-xl text-sm font-bold text-white bg-blue-700 hover:bg-blue-600 transition duration-150" data-target="markah-ujian-view">
                <i class="fas fa-pencil-alt mr-2"></i> UJIAN (30%)
            </a>
            <a href="#" class="nav-item flex items-center p-3 rounded-xl text-sm font-bold text-white bg-green-700 hover:bg-green-600 transition duration-150" data-target="markah-hp3-view">
                <i class="fas fa-running mr-2"></i> AMALI HP3 (50%)
            </a>
            <a href="#" class="nav-item flex items-center p-3 rounded-xl text-sm font-bold text-white bg-yellow-600 hover:bg-yellow-500 transition duration-150" data-target="markah-hp7-view">
                <i class="fas fa-tools mr-2"></i> PENYEDIAAN HP7 (20%)
            </a>
        </nav>
    </header>

    <div class="main-content-area bg-gray-50">
        
        <section id="dashboard-view" class="content-section">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-yellow-500">
                    <p class="text-sm font-semibold text-gray-500">Status Data Pelajar</p>
                    <div class="text-3xl font-bold text-gray-900 mt-1" id="total-students">Memuatkan...</div>
                    <p class="text-sm text-gray-600">Pelajar yang direkodkan dalam sistem.</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500">
                    <p class="text-sm font-semibold text-gray-500">Akses Penuh Data</p>
                    <a href="https://docs.google.com/spreadsheets/d/1_Sw7I8uYiFBJGpjWbMTo53DisiIgGMfui5jMa5AzL7g/edit" target="_blank" class="text-blue-600 hover:text-blue-800 font-bold text-lg block mt-1">
                        Buka Google Spreadsheet ‚Üó
                    </a>
                    <p class="text-sm text-gray-600">Untuk pengiraan HP Akhir dan Analisis.</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                    <p class="text-sm font-semibold text-gray-500">Agihan Markah Penuh</p>
                    <div class="text-sm text-gray-900 mt-1 font-bold">Ujian (30%) + Amali HP3 (50%) + Penyediaan HP7 (20%)</div>
                    <p class="text-sm text-gray-600">Jumlah Markah Keseluruhan: 100%</p>
                </div>
            </div>
        </section>
        
        <section id="data-pelajar-view" class="content-section">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-blue-600">Muat Naik Data Pelajar Pukal (DATA_PELAJAR)</h2>
                <p class="mb-4 text-red-600 font-bold">‚ö†Ô∏è PERHATIAN: Tindakan ini akan **memadam dan menggantikan** semua rekod pelajar sedia ada dalam sistem. Gunakan hanya untuk kemas kini penuh atau muat naik awal.</p>
                
                <form id="bulk-upload-form" class="space-y-6 p-4 border rounded-lg bg-gray-50">
                    <input type="hidden" name="isBulkUpload" value="true">
                    
                    <div class="mb-4 bg-yellow-100 p-4 rounded-lg border border-yellow-300">
                        <h3 class="font-bold text-sm text-gray-700 mb-2">Struktur Fail CSV Wajib:</h3>
                        <code class="block bg-yellow-200 p-2 rounded text-xs text-black break-words">ID_SISTEM, Nama_Pelajar, Jantina, No_KP, No_Giliran, Kelas, Penilai</code>
                        <p class="mt-2 text-xs text-gray-700">Pastikan **turutan** dan **ejaan header** fail CSV anda adalah tepat seperti di atas.</p>
                    </div>

                    <div class="mb-4">
                        <label for="student_csv_file" class="block text-sm font-bold text-gray-700">Pilih Fail CSV Pelajar</label>
                        <input type="file" id="student_csv_file" name="file" accept=".csv" required class="mt-1 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-white focus:outline-none p-2">
                    </div>
                    
                    <button type="submit" id="submit-bulk-upload" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg">
                        MUAT NAIK SEBAGAI DATA PUKAL
                    </button>
                    <div id="bulk-upload-response-message" class="mt-4 p-3 rounded text-center font-medium hidden"></div>
                </form>
            </div>
        </section>

        <section id="markah-ujian-view" class="content-section">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-blue-600">Kemasukan Markah Ujian (30%)</h2>
                
                <form id="ujian-form" class="space-y-6 p-4 border rounded-lg bg-gray-50">
                    <input type="hidden" name="sheet" value="MARKAH_UJIAN">
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end border-b pb-4 border-gray-300">
                        <div class="col-span-1">
                            <label for="select_class_ujian" class="block text-sm font-bold text-gray-700">1. Pilih Kelas</label>
                            <select id="select_class_ujian" class="select-class mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border bg-white font-semibold" data-target-id="ujian_id_sistem" data-target-name="ujian_nama_pelajar">
                                <option value="">-- Muat Turun Kelas --</option>
                            </select>
                        </div>
                        
                        <div class="col-span-1">
                            <label for="ujian_id_sistem" class="block text-sm font-bold text-gray-700">2. Pilih ID Pelajar</label>
                            <select id="ujian_id_sistem" name="ID_SISTEM" required class="select-id mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white font-semibold" disabled>
                                <option value="">Sila Pilih Kelas Dahulu</option>
                            </select>
                        </div>

                        <div class="col-span-1">
                            <label for="ujian_nama_pelajar" class="block text-sm font-medium text-gray-700">Nama Pelajar</label>
                            <input type="text" id="ujian_nama_pelajar" name="Nama_Pelajar" readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-200 p-2 border">
                        </div>

                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700">Jumlah Ujian (30%)</label>
                            <input type="text" id="ujian_jumlah" name="Jumlah_Ujian" readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-yellow-100 p-2 border font-bold text-lg text-red-600">
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-blue-500">
                        <h3 class="text-lg font-semibold mb-3">‚úçÔ∏è Komponen Ujian (Maksimum 30.0)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <label for="ujian_s1a" class="block text-sm font-medium text-gray-700">Soalan 1(a) (Maks 5.0)</label>
                                <input type="number" id="ujian_s1a" name="S1A_Markah" min="0.0" max="5.0" step="0.1" required class="input-markah-ujian mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="ujian_s1b" class="block text-sm font-medium text-gray-700">Soalan 1(b) (Maks 5.0)</label>
                                <input type="number" id="ujian_s1b" name="S1B_Markah" min="0.0" max="5.0" step="0.1" required class="input-markah-ujian mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="ujian_s2a" class="block text-sm font-medium text-gray-700">Soalan 2(a) (Maks 5.0)</label>
                                <input type="number" id="ujian_s2a" name="S2A_Markah" min="0.0" max="5.0" step="0.1" required class="input-markah-ujian mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="ujian_s2b" class="block text-sm font-medium text-gray-700">Soalan 2(b) (Maks 5.0)</label>
                                <input type="number" id="ujian_s2b" name="S2B_Markah" min="0.0" max="5.0" step="0.1" required class="input-markah-ujian mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="ujian_s1c" class="block text-sm font-medium text-gray-700">Soalan 1(c) (Maks 10.0)</label>
                                <input type="number" id="ujian_s1c" name="S1C_Markah" min="0.0" max="10.0" step="0.1" required class="input-markah-ujian mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" id="submit-ujian" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg">
                        Hantar Markah Ujian ke Google Sheets
                    </button>
                    <div id="ujian-response-message" class="mt-4 p-3 rounded text-center font-medium hidden"></div>
                </form>

            </div>
        </section>

        <section id="markah-hp3-view" class="content-section">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-blue-600">Kemasukan Markah Amali HP3 (50%)</h2>
                <p class="mb-4 text-gray-600">Balapan (25%) dan Padang (25%)</p>
                
                <form id="hp3-form" class="space-y-6 p-4 border rounded-lg bg-gray-50">
                    <input type="hidden" name="sheet" value="MARKAH_AMALI_HP3">
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end border-b pb-4 border-gray-300">
                        <div class="col-span-1">
                            <label for="select_class_hp3" class="block text-sm font-bold text-gray-700">1. Pilih Kelas</label>
                            <select id="select_class_hp3" class="select-class mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border bg-white font-semibold" data-target-id="hp3_id_sistem" data-target-name="hp3_nama_pelajar">
                                <option value="">-- Muat Turun Kelas --</option>
                            </select>
                        </div>
                        
                        <div class="col-span-1">
                            <label for="hp3_id_sistem" class="block text-sm font-bold text-gray-700">2. Pilih ID Pelajar</label>
                            <select id="hp3_id_sistem" name="ID_SISTEM" required class="select-id mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white font-semibold" disabled>
                                <option value="">Sila Pilih Kelas Dahulu</option>
                            </select>
                        </div>

                        <div class="col-span-1">
                            <label for="hp3_nama_pelajar" class="block text-sm font-medium text-gray-700">Nama Pelajar</label>
                            <input type="text" id="hp3_nama_pelajar" name="Nama_Pelajar" readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-200 p-2 border">
                        </div>

                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700">Jumlah HP3 (50%)</label>
                            <input type="text" id="hp3_jumlah" name="Jumlah_HP3" readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-yellow-100 p-2 border font-bold text-lg text-red-600">
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-blue-500">
                        <h3 class="text-lg font-semibold mb-3">üèÉ Balapan (25%)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="hp3_permulaan" class="block text-sm font-medium text-gray-700">Fasa Permulaan (Maks 10)</label>
                                <input type="number" id="hp3_permulaan" name="HP3_Permulaan_10" min="0" max="10" required class="input-markah mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="hp3_larian" class="block text-sm font-medium text-gray-700">Fasa Larian (Maks 10)</label>
                                <input type="number" id="hp3_larian" name="HP3_Larian_10" min="0" max="10" required class="input-markah mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="hp3_penamat" class="block text-sm font-medium text-gray-700">Fasa Penamat (Maks 5)</label>
                                <input type="number" id="hp3_penamat" name="HP3_Penamat_5" min="0" max="5" required class="input-markah mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-green-500">
                        <h3 class="text-lg font-semibold mb-3">üéØ Padang (25%)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="hp3_persediaan" class="block text-sm font-medium text-gray-700">Fasa Persediaan (Maks 5)</label>
                                <input type="number" id="hp3_persediaan" name="HP3_Persediaan_5" min="0" max="5" required class="input-markah mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="hp3_lungsuran" class="block text-sm font-medium text-gray-700">Fasa Lungsuran (Maks 5)</label>
                                <input type="number" id="hp3_lungsuran" name="HP3_Lungsuran_5" min="0" max="5" required class="input-markah mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="hp3_lontaran" class="block text-sm font-medium text-gray-700">Fasa Lontaran (Maks 10)</label>
                                <input type="number" id="hp3_lontaran" name="HP3_Lontaran_10" min="0" max="10" required class="input-markah mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="hp3_pulihan" class="block text-sm font-medium text-gray-700">Fasa Pulihan (Maks 5)</label>
                                <input type="number" id="hp3_pulihan" name="HP3_Pulihan_5" min="0" max="5" required class="input-markah mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" id="submit-hp3" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg">
                        Hantar Markah HP3 ke Google Sheets
                    </button>
                    <div id="hp3-response-message" class="mt-4 p-3 rounded text-center font-medium hidden"></div>
                </form>
            </div>
        </section>

        <section id="markah-hp7-view" class="content-section">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-blue-600">Kemasukan Markah Penyediaan HP7 (20%)</h2>
                <p class="mb-4 text-gray-600">Penyediaan Trek (10%) dan Sektor (10%)</p>
                
                <form id="hp7-form" class="space-y-6 p-4 border rounded-lg bg-gray-50">
                    <input type="hidden" name="sheet" value="MARKAH_HP7">
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end border-b pb-4 border-gray-300">
                        <div class="col-span-1">
                            <label for="select_class_hp7" class="block text-sm font-bold text-gray-700">1. Pilih Kelas</label>
                            <select id="select_class_hp7" class="select-class mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border bg-white font-semibold" data-target-id="hp7_id_sistem" data-target-name="hp7_nama_pelajar">
                                <option value="">-- Muat Turun Kelas --</option>
                            </select>
                        </div>
                        
                        <div class="col-span-1">
                            <label for="hp7_id_sistem" class="block text-sm font-bold text-gray-700">2. Pilih ID Pelajar</label>
                            <select id="hp7_id_sistem" name="ID_SISTEM" required class="select-id mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white font-semibold" disabled>
                                <option value="">Sila Pilih Kelas Dahulu</option>
                            </select>
                        </div>

                        <div class="col-span-1">
                            <label for="hp7_nama_pelajar" class="block text-sm font-medium text-gray-700">Nama Pelajar</label>
                            <input type="text" id="hp7_nama_pelajar" name="Nama_Pelajar" readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-200 p-2 border">
                        </div>

                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700">Jumlah HP7 (20%)</label>
                            <input type="text" id="hp7_jumlah" name="Jumlah_HP7" readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-yellow-100 p-2 border font-bold text-lg text-red-600">
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-yellow-500">
                        <h3 class="text-lg font-semibold mb-3">üõ†Ô∏è Komponen Penyediaan (Maksimum 20.0)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="hp7_trek" class="block text-sm font-medium text-gray-700">Penyediaan Trek (Maks 10)</label>
                                <input type="number" id="hp7_trek" name="HP7_Penyediaan_Trek_10" min="0" max="10" required class="input-markah-hp7 mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="hp7_sektor" class="block text-sm font-medium text-gray-700">Penyediaan Sektor (Maks 10)</label>
                                <input type="number" id="hp7_sektor" name="HP7_Penyediaan_Sektor_10" min="0" max="10" required class="input-markah-hp7 mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" id="submit-hp7" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg">
                        Hantar Markah HP7 ke Google Sheets
                    </button>
                    <div id="hp7-response-message" class="mt-4 p-3 rounded text-center font-medium hidden"></div>

                </form>
            </div>
        </section>

    </div>
    
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <script>
        // =================================================================
        // URL APLIKASI WEB ANDA (Disahkan dan Terkini)
        // =================================================================
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzhDIHB50y9t3SQxP-D0zuXUKdfd7zu_eqXMh3hYURgZFLd3pI3H1Qd1hDHtgdZh7MCtg/exec'; 
        // =================================================================

        let ALL_STUDENT_DATA = [];

        // --- FUNGSI PENGIRAAN MARKAH ---

        function calculateHp3Total() {
            const inputs = document.querySelectorAll('#hp3-form .input-markah');
            let total = 0;
            inputs.forEach(input => {
                const value = input.valueAsNumber || 0; 
                const max = parseInt(input.getAttribute('max'));
                if (value > max) { input.value = max; total += max; } else { total += value; }
            });
            document.getElementById('hp3_jumlah').value = total.toFixed(1);
        }
        function calculateHp7Total() {
            const inputs = document.querySelectorAll('#hp7-form .input-markah-hp7');
            let total = 0;
            inputs.forEach(input => {
                const value = input.valueAsNumber || 0; 
                const max = parseInt(input.getAttribute('max'));
                if (value > max) { input.value = max; total += max; } else { total += value; }
            });
            document.getElementById('hp7_jumlah').value = total.toFixed(1);
        }
        function calculateUjianTotal() {
            const inputs = document.querySelectorAll('#ujian-form .input-markah-ujian');
            let total = 0;
            inputs.forEach(input => {
                const value = input.valueAsNumber || 0; 
                const max = parseFloat(input.getAttribute('max'));
                if (value > max) { input.value = max; total += max; } else { total += value; }
            });
            document.getElementById('ujian_jumlah').value = total.toFixed(1);
        }
        
        // --- FUNGSI MUAT TURUN DATA PELAJAR (Diperbaiki untuk Elak Stuck) ---
        async function fetchStudentData() {
            const studentCountElement = document.getElementById('total-students');
            studentCountElement.textContent = "Memuatkan...";

            document.querySelectorAll('.select-class').forEach(d => d.disabled = true);
            
            try {
                const response = await fetch(WEB_APP_URL); 
                const result = await response.json();

                if (result.result === 'success') {
                    ALL_STUDENT_DATA = result.data;
                    populateClassDropdowns(ALL_STUDENT_DATA);
                    
                    studentCountElement.textContent = ALL_STUDENT_DATA.length;

                    document.querySelectorAll('.select-class').forEach(d => d.disabled = false);
                } else {
                    console.error('‚ùå Ralat memuatkan data:', result.message);
                    studentCountElement.textContent = 'Ralat Akses!';
                    document.querySelectorAll('.select-class').forEach(d => d.disabled = false);
                }
            } catch (error) {
                console.error('‚ùå Ralat fetch/rangkaian:', error);
                studentCountElement.textContent = 'Ralat Rangkaian!';
                document.querySelectorAll('.select-class').forEach(d => d.disabled = false);
            }
        }
        
        // --- FUNGSI UNTUK MENGISI DROPDOWN KELAS ---
        function populateClassDropdowns(data) {
            const classSet = new Set();
            data.forEach(student => {
                if (student.Kelas && student.Kelas.trim() !== "") { classSet.add(student.Kelas.trim()); }
            });
            const uniqueClasses = Array.from(classSet).sort();
            const classDropdowns = document.querySelectorAll('.select-class');

            classDropdowns.forEach(dropdown => {
                dropdown.innerHTML = '<option value="">-- Sila Pilih Kelas --</option>'; 
                uniqueClasses.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    dropdown.appendChild(option);
                });
            });
        }
        
        // --- FUNGSI UNTUK MENGENDALIKAN PERUBAHAN PILIHAN KELAS ---
        function handleClassChange(event) {
            const selectedClass = event.target.value;
            const targetId = event.target.getAttribute('data-target-id');
            const targetName = event.target.getAttribute('data-target-name');
            
            const idDropdown = document.getElementById(targetId);
            const nameInput = document.getElementById(targetName);

            idDropdown.innerHTML = '';
            idDropdown.disabled = true;
            nameInput.value = '';
            
            if (!selectedClass) {
                idDropdown.innerHTML = '<option value="">Sila Pilih Kelas Dahulu</option>';
                return;
            }

            const filteredStudents = ALL_STUDENT_DATA
                .filter(student => student.Kelas === selectedClass)
                .sort((a, b) => a.Nama_Pelajar.localeCompare(b.Nama_Pelajar)); 

            idDropdown.disabled = false;
            idDropdown.innerHTML = '<option value="">-- Pilih ID/Nama Pelajar --</option>';
            
            filteredStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.ID_SISTEM; 
                option.textContent = `${student.ID_SISTEM} - ${student.Nama_Pelajar}`;
                option.setAttribute('data-student-name', student.Nama_Pelajar);
                idDropdown.appendChild(option);
            });

            idDropdown.onchange = function() {
                const selectedOption = this.options[this.selectedIndex];
                nameInput.value = selectedOption.getAttribute('data-student-name') || '';
                
                const formId = this.form.id;
                if (formId === 'hp3-form') calculateHp3Total();
                if (formId === 'hp7-form') calculateHp7Total();
                if (formId === 'ujian-form') calculateUjianTotal();
            };
        }


        // --- FUNGSI GENERIC PENGHANTARAN BORANG ---
        async function submitForm(formId, submitButtonId, responseMessageId) {
            const form = document.getElementById(formId);
            const submitButton = document.getElementById(submitButtonId);
            const responseMessage = document.getElementById(responseMessageId);

            if (form.querySelector('select[name="ID_SISTEM"]').value.trim() === '') {
                alert('Sila pilih ID Pelajar yang sah.');
                return;
            }

            submitButton.textContent = 'Menghantar... Sila Tunggu';
            submitButton.disabled = true;
            responseMessage.classList.add('hidden');
            
            const formData = new FormData(form);
            
            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', body: formData });
                const result = await response.json();

                responseMessage.classList.remove('hidden');
                if (result.result === 'success') {
                    responseMessage.textContent = `‚úÖ Markah berjaya direkodkan ke helaian ${formData.get('sheet')}!`;
                    responseMessage.classList.remove('bg-red-100', 'text-red-700');
                    responseMessage.classList.add('bg-green-100', 'text-green-700');
                    form.reset(); 
                } else {
                    throw new Error(result.message || 'Gagal merekodkan data.');
                }
            } catch (error) {
                responseMessage.textContent = `‚ùå Ralat: ${error.message}`;
                responseMessage.classList.remove('bg-green-100', 'text-green-700');
                responseMessage.classList.add('bg-red-100', 'text-red-700');
            } finally {
                submitButton.textContent = `Hantar Markah ke Google Sheets`;
                submitButton.disabled = false;
                if (formId === 'hp3-form') calculateHp3Total();
                if (formId === 'hp7-form') calculateHp7Total();
                if (formId === 'ujian-form') calculateUjianTotal();
            }
        }

        // --- FUNGSI PENGENDALIAN ACARA (EVENT HANDLERS) ---
        document.addEventListener('DOMContentLoaded', () => {
            const navItems = document.querySelectorAll('.nav-item');
            const contentSections = document.querySelectorAll('.content-section');

            function showSection(targetId) {
                contentSections.forEach(section => { section.style.display = 'none'; });
                document.getElementById(targetId).style.display = 'block';
            }

            // Pengendalian Navigasi
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const target = e.currentTarget.getAttribute('data-target');
                    
                    navItems.forEach(nav => nav.classList.remove('bg-green-700', 'bg-blue-700', 'bg-yellow-600', 'bg-gray-700'));
                    
                    if (target === 'markah-hp3-view') { e.currentTarget.classList.add('bg-green-700'); } 
                    else if (target === 'markah-ujian-view') { e.currentTarget.classList.add('bg-blue-700'); } 
                    else if (target === 'markah-hp7-view') { e.currentTarget.classList.add('bg-yellow-600'); } 
                    else { e.currentTarget.classList.add('bg-gray-700'); }
                    
                    showSection(target);
                });
            });

            // Pengendalian Pengiraan Markah
            const hp3Inputs = document.querySelectorAll('#hp3-form .input-markah');
            hp3Inputs.forEach(input => { input.addEventListener('input', calculateHp3Total); }); calculateHp3Total(); 
            const hp7Inputs = document.querySelectorAll('#hp7-form .input-markah-hp7');
            hp7Inputs.forEach(input => { input.addEventListener('input', calculateHp7Total); }); calculateHp7Total(); 
            const ujianInputs = document.querySelectorAll('#ujian-form .input-markah-ujian');
            ujianInputs.forEach(input => { input.addEventListener('input', calculateUjianTotal); }); calculateUjianTotal(); 

            // Pengendalian Penghantaran Borang
            document.getElementById('hp3-form').addEventListener('submit', (e) => { e.preventDefault(); submitForm('hp3-form', 'submit-hp3', 'hp3-response-message'); });
            document.getElementById('hp7-form').addEventListener('submit', (e) => { e.preventDefault(); submitForm('hp7-form', 'submit-hp7', 'hp7-response-message'); });
            document.getElementById('ujian-form').addEventListener('submit', (e) => { e.preventDefault(); submitForm('ujian-form', 'submit-ujian', 'ujian-response-message'); });
            
            // Pengendalian Muat Naik Pukal
            const bulkUploadForm = document.getElementById('bulk-upload-form');
            const bulkSubmitButton = document.getElementById('submit-bulk-upload');
            const bulkResponseMessage = document.getElementById('bulk-upload-response-message');

            bulkUploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!document.getElementById('student_csv_file').files[0]) { alert('Sila pilih fail CSV.'); return; }

                bulkSubmitButton.textContent = 'Memproses Fail... Sila Tunggu';
                bulkSubmitButton.disabled = true;
                bulkResponseMessage.classList.add('hidden');
                
                const formData = new FormData(bulkUploadForm);
                
                try {
                    const response = await fetch(WEB_APP_URL, { method: 'POST', body: formData });
                    const result = await response.json();

                    bulkResponseMessage.classList.remove('hidden');
                    if (result.result === 'success') {
                        bulkResponseMessage.textContent = `‚úÖ Berjaya! ${result.count} rekod pelajar telah dikemas kini. Sila refresh laman ini.`;
                        bulkResponseMessage.classList.remove('bg-red-100', 'text-red-700');
                        bulkResponseMessage.classList.add('bg-green-100', 'text-green-700');
                        bulkUploadForm.reset(); 
                        setTimeout(fetchStudentData, 2000); 
                    } else {
                        throw new Error(result.message || 'Gagal memproses muat naik fail.');
                    }
                } catch (error) {
                    bulkResponseMessage.textContent = `‚ùå Ralat: ${error.message}`;
                    bulkResponseMessage.classList.remove('bg-green-100', 'text-green-700');
                    bulkResponseMessage.classList.add('bg-red-100', 'text-red-700');
                } finally {
                    bulkSubmitButton.textContent = 'MUAT NAIK SEBAGAI DATA PUKAL';
                    bulkSubmitButton.disabled = false;
                }
            });
            
            // Panggil fungsi pemuatan data pelajar
            fetchStudentData(); 
            
            // Lampirkan pengendali acara (event listener) kepada semua dropdown Kelas
            const classDropdowns = document.querySelectorAll('.select-class');
            classDropdowns.forEach(dropdown => { dropdown.addEventListener('change', handleClassChange); });
        });
    </script>
</body>
</html>
